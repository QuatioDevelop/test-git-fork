name: ðŸ”§ Backend-Only Flow

run-name: ðŸ”§ Backend-Only Flow to ${{ inputs.environment }}

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
    outputs:
      success:
        description: 'Whether the flow completed successfully'
        value: ${{ jobs.deploy.outputs.success }}

env:
  AWS_REGION: us-east-1

jobs:
  determine-environment:
    uses: ./.github/workflows/determine-environment.yml
    with:
      environment: ${{ inputs.environment }}

  deploy:
    runs-on: ubuntu-latest
    needs: determine-environment
    outputs:
      success: ${{ steps.deploy.outputs.success }}
    environment: 
      name: ${{ needs.determine-environment.outputs.environment }}-backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate backend deployment
        id: deploy
        run: |
          echo "ðŸ”§ [SIMULATED] Deploying backend-only infrastructure..."
          echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "Region: ${{ env.AWS_REGION }}"
          
          # Simulate backend deployment steps
          echo "ðŸ“¦ Building SAM application..."
          echo "ðŸ”§ Validating SAM template..."
          echo "ðŸš€ Deploying Lambda functions..."
          echo "ðŸ—„ï¸ Updating DynamoDB tables..."
          echo "ðŸ”— Configuring API Gateway..."
          echo "ðŸ” Setting up IAM roles and policies..."
          
          # Show what backend files we're deploying
          echo "ðŸ“ Backend files to deploy:"
          find iac/backend -name "*.yml" -o -name "*.yaml" -o -name "*.json" 2>/dev/null | head -5 || echo "No backend config files found"
          
          # Simulate deployment time
          sleep 15
          
          echo "âœ… Backend deployment completed successfully (simulated)"
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Simulate post-deployment verification
        run: |
          echo "ðŸ” [SIMULATED] Verifying backend deployment..."
          echo "âœ… API Gateway endpoints responding"
          echo "âœ… Lambda functions deployed"
          echo "âœ… DynamoDB tables accessible"
          echo "âœ… Backend health check passed"

      - name: Summary
        run: |
          echo "## ðŸ”§ Backend-Only Flow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ SAM Application: âœ… Built and deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Lambda Functions: âœ… Updated" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—„ï¸ DynamoDB Tables: âœ… Configured" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— API Gateway: âœ… Endpoints active" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Health Check: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** Frontend was not deployed in this flow" >> $GITHUB_STEP_SUMMARY